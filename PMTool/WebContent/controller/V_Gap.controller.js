sap.ui.define([
	"sap/ui/core/mvc/Controller",
	"sap/ui/core/routing/History",
	"sap/m/MessageToast",
	"sap/m/MessageBox"
], function(Controller, History, MessageToast, MessageBox) {
	"use strict";
	var oObjnr;
	var sMsg;
	var oCancelTable;
	var aIndex;

	return Controller.extend("PMTool.controller.V_Gap", {
		/**
		 * Called when a controller is instantiated and its View controls (if available) are already created.
		 * Can be used to modify the View before it is displayed, to bind event handlers and do other one-time initialization.
		 * @memberOf PMTool.view.V_Gap
		 */
		onInit: function() {
			var oView = this.getView();
			var oTable = oView.byId("Gap_Table");
			oView.addEventDelegate({
				onAfterShow: function(oEvent) {
					oTable.bindRows({
                    path: "/GapMasterSet",
					key: ["ZprojId", "ZgapNo"]
					});

				}

			}, oView);
		
		},

		rebindTable: function() {
			var oTable = this.getView().byId("Gap_Table");
			oTable.bindRows({
				path: "/GapMasterSet",
				key: ["ZprojId", "ZgapNo"]
			});
		},
	
		handleRouteMatched: function(evt) {
			//						console.log("onRoute");
			this.rebindTable();
		},
		// onBeforeRendering: function() {
		// 	this.oModel = this.getView().getModel();
		// 	var dialog = new sap.m.BusyDialog({
		// 		text: 'Processing'
		// 	});
		// 	this.oModel.attachRequestSent(function() {
		// 		dialog.open();
		// 	});
		// 	this.oModel.attachRequestCompleted(function() {
		// 		dialog.close();
		// 	});
		// 	this.oModel.attachRequestFailed(function() {
		// 		dialog.close();
		// 	});
		// 	},

	fGoToTarget_1: function() {
			//This code was generated by the layout editor.
			var oHistory = History.getInstance();
			var sPreviousHash = oHistory.getPreviousHash();
			// Go one screen back if you find a Hash
			if (sPreviousHash !== undefined) {
				window.history.go(-1);
			} // If you do not find a correct Hash, go to the Source screen using default router;
			else {
				var oRouter = sap.ui.core.UIComponent.getRouterFor(this);
				oRouter.navTo("", true);
			}
		},
		onExit: function() {
			this.aGapMasterSet = [];
		},
		/**
		 *@memberOf PMTool.controller.V_Gap
		 */
		
		fChangeGap: function() {
			var oView = this.getView();
			var oTable = oView.byId("Gap_Table");
			var aIndex = oTable.getSelectedIndex();
			var oDialog = oView.byId("idGapDialogChange");
			// create dialog lazily
			if (!oDialog) {
				// create dialog via fragment factory
				oDialog = sap.ui.xmlfragment(oView.getId(), "PMTool.view.GapChange", this);
				// connect dialog to view (models, lifecycle)
				oView.addDependent(oDialog);
			}
 
			oDialog.open();
			var oContext    = oTable.getContextByIndex(aIndex);
			var chZprojId    = oContext.getProperty("ZprojId");
			var chZgapNo     =  oContext.getProperty("ZgapNo");
			var chZdomain    = oContext.getProperty("Zdomain");
			var chZspecName  = oContext.getProperty("ZspecName");
			var chZgapResp   =  oContext.getProperty("ZgapResp");
			var chZgaptitle  = oContext.getProperty("Zgaptitle");
			var chZgapStatus = oContext.getProperty("ZgapStatus");
			var chZgapdesc   =  oContext.getProperty("Zgapdesc");
			var chZbusiPriority  = oContext.getProperty("ZbusiPriority");
			var chZsolution  =  oContext.getProperty("Zsolution");
			
			oView.byId("inProjectId").setValue(chZprojId);
			oView.byId("inGapNo").setValue(chZgapNo);
			oView.byId("inDomain").setValue(chZdomain);
			oView.byId("inSpecificationName").setValue(chZspecName);
			oView.byId("inUserName").setValue(chZgapResp);
			oView.byId("inGapTitle").setValue(chZgaptitle);
			oView.byId("inGapStatus").setValue(chZgapStatus);
			oView.byId("inGapDesc").setValue(chZgapdesc);
			
			oView.byId("inCriticality").setValue(chZbusiPriority);
			oView.byId("inSolution").setValue(chZsolution);
			
			
		},	
		// fvalidate_gap  : function() {
		// 	{
		// 	    var oModel = this.getView().getModel();
		// 		var oEntry = {};
		// 		oEntry.Zdeveloper = this.getView().byId("CGapNo").getValue();
		// 		if (oEntry.Zdeveloper < 1 )
		// 		{
		// 		this.getView().byId("CGapNo").setValueState(sap.ui.core.ValueState.Error);	
		// 		}
		// 		else
		// 		{
		// 		this.getView().byId("CGapNo").setValueState(sap.ui.core.ValueState.None);		
		// 		}
		// 	}
		// 	},
		
		fCopyGap: function() {
			var oView = this.getView();
			var oTable = oView.byId("Gap_Table");
			var aIndex = oTable.getSelectedIndex();
			var oDialog = oView.byId("idGapDialogCopy");
			// create dialog lazily
			if (!oDialog) {
				// create dialog via fragment factory
				oDialog = sap.ui.xmlfragment(oView.getId(), "PMTool.view.GapCopy", this);
				// connect dialog to view (models, lifecycle)
				oView.addDependent(oDialog);
			}
            oDialog.open();
     		var oContext    = oTable.getContextByIndex(aIndex);
			var cZprojId    = oContext.getProperty("ZprojId");
			var cZgapNo     =  oContext.getProperty("ZgapNo");
			var cZdomain    = oContext.getProperty("Zdomain");
			var cZspecName  = oContext.getProperty("ZspecName");
			var cZgapResp   =  oContext.getProperty("ZgapResp");
			var cZgaptitle  = oContext.getProperty("Zgaptitle");
			var cZgapStatus = oContext.getProperty("ZgapStatus");
			var cZgapdesc   =  oContext.getProperty("Zgapdesc");
			
		    var cZbusiPriority  = oContext.getProperty("ZbusiPriority");
			var cZsolution  =  oContext.getProperty("Zsolution");
			
			oView.byId("CProjectId").setValue(cZprojId);
			oView.byId("CGapNo").setValue(cZgapNo);
			oView.byId("CDomain").setValue(cZdomain);
			oView.byId("CSpecificationName").setValue(cZspecName);
			oView.byId("CUserName").setValue(cZgapResp);
			oView.byId("CGapTitle").setValue(cZgaptitle);
			oView.byId("CGapStatus").setValue(cZgapStatus);
			oView.byId("CGapDesc").setValue(cZgapdesc);
			oView.byId("CCriticality").setValue(cZbusiPriority);
			oView.byId("CSolution").setValue(cZsolution);
			},
		onCloseCopyDialog : function () {
			this.getView().byId("idGapDialogCopy").close();
		},
		onCloseChangeDialog : function () {
			this.getView().byId("idGapDialogChange").close();
		},

/*		fDeleteGap: function() {
            var oView = this.getView();
			var oDialog = oView.byId("idGapDialogDelete");
			// create dialog lazily
			if (!oDialog) {
				// create dialog via fragment factory
				oDialog = sap.ui.xmlfragment(oView.getId(), "PMTool.view.GapDelete", this);
				// connect dialog to view (models, lifecycle)
				oView.addDependent(oDialog);
			}
 
			oDialog.open();
		},
		
		onCloseDeleteDialog : function () {
			this.getView().byId("idGapDialogDelete").close();
		//	this.rebindTable();
		},*/
		
		fSaveChangeGap: function() {
			var oView = this.getView();
			var oTable = oView.byId("Gap_Table");
			var aIndex = oTable.getSelectedIndex();
			var contexts = oTable.getContextByIndex(aIndex);
			var set = contexts.sPath;

			/*Update operation*/
			var oModel = oTable.getModel();
			var oEntry = {};
			oEntry.ZprojId = oView.byId("inProjectId").getValue();
			oEntry.ZgapNo = oView.byId("inGapNo").getValue();
			oEntry.Zdomain = oView.byId("inDomain").getValue();
			oEntry.ZspecName = oView.byId("inSpecificationName").getValue();
			oEntry.ZgapResp = oView.byId("inUserName").getValue();
			oEntry.Zgaptitle = oView.byId("inGapTitle").getValue();
			oEntry.ZgapStatus = oView.byId("inGapStatus").getValue();
			oEntry.Zgapdesc = oView.byId("inGapDesc").getValue();
			
			oEntry.ZbusiPriority = oView.byId("inCriticality").getValue();
			oEntry.Zsolution = oView.byId("inSolution").getValue();
		
			oModel.update(set, oEntry, {
				method: "PUT",
				success: function(data) {
					MessageBox.success("Record has been updated");
				},
				error: function(e) {
					MessageBox.error("Error in updation");
				}
			});
			this.getView().byId("idGapDialogChange").close();
			this.rebindTable();
			// this.getView().byId("idGapDialogChange").destroy();
			// oTable.clearSelection();
			// var oBinding = oTable.getBinding();
			// var aLength = oBinding.getLength();
			// oTable.setVisibleRowCount(aLength);
			
		},
		fSaveCopyGap: function() {
		    var iError = 0;  
			var oView = this.getView();
			var oTable = oView.byId("Gap_Table");
			aIndex = oTable.getSelectedIndex();
			// var contexts = oTable.getContextByIndex(aIndex);
			// var set = contexts.sPath;
	     	var oModel = oTable.getModel();
			var oEntry = {};
			var ZprojId1 = oView.byId("CProjectId").getSelectedItem();
			oEntry.ZgapNo = oView.byId("CGapNo").getValue();
			oEntry.Zdomain = oView.byId("CDomain").getValue();
			oEntry.ZspecName = oView.byId("CSpecificationName").getValue();
			oEntry.ZgapResp = oView.byId("CUserName").getValue();
			oEntry.Zgaptitle = oView.byId("CGapTitle").getValue();
			oEntry.ZgapStatus = oView.byId("CGapStatus").getValue();
			oEntry.Zgapdesc = oView.byId("CGapDesc").getValue();
			
			oEntry.ZbusiPriority = oView.byId("CCriticality").getValue();
			oEntry.Zsolution = oView.byId("CSolution").getValue();
		// if (oEntry.ZprojId === "") {
		// 		MessageToast.show("Please enter Project Master ID");
		// 	} 
		// 	else 
		// 	{
		// 			if (oEntry.ZgapNo === "") {
		// 		MessageToast.show("Please enter Gap Number");
		      if( ZprojId1 != null)
		 		{
		 		var oKey = ZprojId1.getKey();
		     	oEntry.ZprojId = oKey;
		 		}
		 		
		        if( ZprojId1 === null )
			{
				 ZprojId1 =oView.byId("CProjectId").getValue();
				 oEntry.ZprojId = ZprojId1;
			}
			
		       if( ZprojId1 === null ||  ZprojId1 < 1 ){ 
				this.getView().byId("CProjectId").setValueState(sap.ui.core.ValueState.Error);
				this.getView().byId("CProjectId").setTooltip("Pls select valid project");
				iError++;
			}
			else{
					this.getView().byId("CProjectId").setValueState(sap.ui.core.ValueState.None);
					this.getView().byId("CProjectId").destroyTooltip();
			}
			if(oEntry.ZgapNo === "" || oEntry.ZgapNo < 1 ){ 
				this.getView().byId("CGapNo").setValueState(sap.ui.core.ValueState.Error);
				this.getView().byId("CGapNo").setTooltip("Pls enter a number between 1 and 999");
				iError++;
			}
			else{
					this.getView().byId("CGapNo").setValueState(sap.ui.core.ValueState.None);
					this.getView().byId("CGapNo").destroyTooltip();
			}
			if (iError > 0){ 
				return;
			}
				else 
		 	{
		 		
				   oModel.create("/GapMasterSet", oEntry, {
					method: "POST",
					success: function(data) {
						MessageBox.success("Record has been saved");
						},
					error: function(e) {
						MessageBox.error("Entry already exist");
					}
				});
			}
			    this.rebindTable();
				this.getView().byId("idGapDialogCopy").close();
		    	
			
		},

			fDeleteGap:function(){
					var oView = this.getView();
					var oTable = oView.byId("Gap_Table");
					var oModel =  oTable.getModel();
				MessageBox.show("Are you sure want to delte this record?",
					{   actions: [sap.m.MessageBox.Action.YES, sap.m.MessageBox.Action.NO],
						onClose:function(oAction){
						if (oAction === sap.m.MessageBox.Action.YES){
					 aIndex = oTable.getSelectedIndex();
					var contexts = oTable.getContextByIndex(aIndex);
					var set = contexts.sPath;

					
				oModel.remove(set, {
						method: "DELETE",
						success: function(data) {
							MessageBox.success("Record has been deleted");
						},
						error: function(e) {
							MessageBox.error("Error in delete");
						}
						});
						this.rebindTable();
						}
						else{
							oTable.clearSelection();
						}
					}}
					);
		
			oTable.setModel(oModel);
			
			
			}
	});
});